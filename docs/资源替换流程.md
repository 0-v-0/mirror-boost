# 资源替换流程

本文档基于 `需求文档.md` 中关于资源替换（镜像替换与统计）的需求，描述扩展在运行时如何识别、选择、替换和回退静态资源的完整流程，以及相关的数据模型、并发限制、错误处理与存储策略。

## 一、合同（Contract）

- 输入：
  - 页面中发现的静态资源条目（URL、element/tag、integrity属性、resourceType、initiatorType、host等）。
  - 已配置的URL匹配规则与镜像模板（来自配置或内置镜像库）。
  - 存储在本地的统计数据（按rule或host聚合的样本计数、avgMs）与integrity映射表。
  - 配置项：阈值（thresholdMs）、最小样本数（minSampleCount）、同host并发上限、不同host上限、候选集合大小N、统计TTL等。

- 输出：
  - 对满足替换条件的资源执行替换（将资源URL替换为选定镜像URL）。
  - 在IndexedDB/`src/storage.ts`（或 `keyvalDB` 封装）中写入或更新统计数据与integrity映射条目（节流/批量写入）。
  - 在替换失败或完整性验证失败时记录日志并根据配置回退到原资源或禁用该替换候选。

- 成功标准：
  - 只有在资源带有`integrity`且统计样本数达到`minSampleCount`且平均加载时间超过`thresholdMs`的情况下，才触发替换尝试。
  - 替换后由浏览器执行 SRI 校验，扩展通过加载成功/失败事件判断替换是否有效并作出相应处理。

## 二、总体流程概览（高层）

1. 页面加载/资源发现：当页面加载或动态插入资源时，扩展监听资源元素（`link[rel=stylesheet]`、`script`、`link[rel=icon]`/图标等）及 Resource Timing 收集。仅处理带 `integrity` 属性的资源用于替换判断。
2. 收集与统计：使用 Resource Timing API 和扩展内统计逻辑更新内存中的样本队列（按rule或host聚合），并在节流窗口内批量写入 IndexedDB（stats 表）。
3. 判断替换候选：对每个资源，按优先级先尝试匹配 URL 规则（若匹配则使用规则聚合统计），否则在启用按host统计时使用 host 聚合统计。检查样本计数、平均值与阈值。
4. 选择替换目标：若满足替换条件，从匹配该资源的镜像候选集合中按统计平均加载时间排序，取前 N 个候选并随机选取一个，同时考虑同host并发与不同host数量限制。优先选择与资源 `integrity` 匹配的候选（通过 integrity 映射表筛选）。
5. 执行替换：异步替换资源 URL（不阻塞页面主流程），等待浏览器对替换后的资源进行加载与 SRI 验证。
6. 结果处理：根据加载成功/失败与完整性结果，记录日志、更新候选可用性（短期标记不可用以避免短时间内重复失败）、必要时回退到原资源并调整统计或禁用该替换策略。

## 三、详细步骤

### 3.1 资源发现与预筛选

- 监控点：
  - DOM Mutation（新增script/link/img）
  - 页面导航/初始解析阶段（捕获初始静态资源）
  - Resource Timing API 定期聚合

- 预筛选条件：
  - 资源必须带有 `integrity` 属性（否则不考虑替换）。
  - 资源类型需在规则或默认允许类型范围内（`css`, `js`, `image` 等）。

### 3.2 统计与样本管理

- 内存队列：对每个资源访问事件（load 时间）先写入内存队列，队列按聚合键（ruleId 或 host）分组。
- 节流写入：每隔固定窗口（建议 60s）批量写入 IndexedDB stats 表，或在扩展卸载/页面关闭时强制刷新。
- 样本计算：当样本数达到 `minSampleCount` 时计算 avgMs（增量算法或加权移动平均），并存储样本数、avgMs、firstAt、lastAt。

### 3.3 判断是否触发替换

替换触发条件（必须全部满足）：

1. 资源带有 `integrity`。
2. 聚合样本数 >= `minSampleCount`。
3. 聚合 avgMs >= `thresholdMs`（阈值，单位ms）。
4. 该资源的 URL 匹配到至少一个替换规则或镜像候选集合非空。

如果满足，则进入候选选择步骤；否则记录并跳过替换。

### 3.4 候选选择策略

- 候选来源：内置镜像库、用户配置的镜像、integrity 映射表中的同 integrity URL。优先级：integrity 映射匹配 > 用户规则指定的镜像 > 内置镜像列表。
- 筛选：
  - 若目标资源有对应的 `integrity` 值，优先选择映射表中列出的 URL（这些 URL 已知与同一完整性值匹配）。
  - 从剩余候选中过滤出可用的（未被短期标记为不可用且未超过失败阈值）。
- 排序与随机化：
  - 对候选按其统计 avgMs 升序排序（若候选无统计则视为较大延迟或按配置策略处理）。
  - 取排序后前 N（N 为配置，默认3）形成候选池，从中随机选取一个以减少负载集中。

- 并发/host 限制应用：在执行替换前，检查并确保：
  - 当前页面到同一目标 host 的并发替换数 < 同host并发上限（默认2）。
  - 本次替换会话涉及的不同 host 数量 < 不同host上限（默认4）。
  - 若超过限制，可延迟该替换或选取其他候选（若可行）。

### 3.5 执行替换（实现要点）

- 替换方式：对 DOM 元素直接替换 `src`/`href` 或创建替代元素并在替换成功后移除原元素，推荐采用后者以便回退更简单。

- 异步插入流程示例：
  1. 创建新的元素（script/link/img）并设置候选 URL 与原始 `integrity` 属性（保持一致）。
  2. 将新元素插入 DOM（通常插入到原资源位置或head末尾），监听 load/error 事件与 Resource Timing 的加载条目确认。
  3. 若 load 成功且浏览器没有触发 integrity 错误（即 load 事件触发），标记替换成功并移除原元素（或在下一个微任务移除以减少风险）。
  4. 若 load 失败或 integrity 校验失败（触发 error），记录失败：将该候选短期标记为不可用（例如 5-30 分钟），并按配置回退：
     - 回退策略 A（默认安全）：移除新元素并保留原元素（若原元素还在则无需操作）；
     - 回退策略 B（激进）：尝试下一个候选或恢复到原 URL 并停止更改该资源本次会话中的替换尝试。

### 3.6 结果记录与候选状态管理

- 成功：记录一条替换成功事件（采样或摘要模式），并在统计表中更新候选的成功计数/最后成功时间。
- 失败：将候选短期下线并在内存或数据库中记录失败次数与下线到期时间。
- 持久化：重要操作（如自动添加规则、回退操作、长期失败）按配置写入日志表（遵循采样/限流规则）。

## 四、integrity 映射表使用与维护

- 维护原则：在资源成功加载并携带 `integrity` 属性时，将 URL 加入对应的条目（key 为 integrity 值，例如 `sha256-...`），并更新 `lastSeenAt` 与 TTL（`ttlExpiresAt = now + statsTTLDays`）。
- 写入策略：内存批量缓冲 + 节流写入（例如 60s 或达到条目数上限时触发）。
- 查询优先级：在候选选择时，若存在映射表条目，优先使用映射表中列举的 URL，因为这些 URL 已被观测到与目标 integrity 匹配。
- 清理策略：周期性（例如每天或扩展启动时）或惰性查询时删除过期条目；对 `urls` 列表进行长度限制（例如最多保留 50 条）并清理最旧项。

## 五、自动添加 host 规则（可选功能）

- 触发条件：当 host 的统计 avgMs >= threshold 且样本数 >= minSampleCount 且没有任何 URL 规则匹配该 host 时。
- 创建内容：生成一条 `*://<host>/*` 类似的规则对象，填充 `source: "auto"` 与 `originInfo: { reason: 'host_avg_exceeds_threshold', sampleCount, timestamp }`。
- 启用策略：由配置决定自动启用或默认禁用（建议加入 UI 说明，默认启用可帮助自动加速）。
- 用户交互：在规则管理界面显示自动规则，并支持用户编辑、禁用或删除；提供“一键清除自动生成规则”功能并支持短时间撤销。

## 六、错误处理与日志策略

- 默认不记录详细日志（日志默认关闭）；当用户开启日志时采用采样与限流策略：仅记录错误事件、每类事件上限、或按时间窗口采样。
- 错误分类：网络错误、404/5xx、SRI 校验失败、超时、DOM 插入异常等。记录必要的元数据（resource URL（去查询参数）、candidate URL、host、timestamp、errorType）。
- 安全策略：写入前清理或归一化 URL（移除查询参数或保留白名单参数）以降低隐私风险。

## 七、存储结构建议（与仓库实现对应）

- stats 表（IndexedDB / src/storage.ts 或 keyvalDB）：存储 rule/host 聚合统计：
  - key: `rule:<id>` 或 `host:<hostname>`
  - fields: { id, type: 'rule'|'host', samples, avgMs, firstAt, lastAt }
- integrity_map 表：
  - key: `<integrity_value>`（使用原始 integrity 值作为 key）
  - fields: { integrity, urls[], createdAt, lastSeenAt, ttlExpiresAt }
- candidates 状态（可在内存中维护并周期性同步到 DB）：
  - { url, host, lastFailureAt, failureCount, blacklistedUntil }

建议使用仓库中的 `src/storage.ts`（或若希望保留兼容的封装：`keyvalDB.js`、`mainStorage.js`）等模块封装对 IndexedDB 的读写与事务管理，保持写入节流与批处理。

## 八、与现有仓库文件的结合点（建议改动/接入点）

- 监听与注入点：
  - `src/monitor.ts` 或 `src/replacer.ts` 负责在页面上下文注入资源监控与替换执行逻辑（DOM 监听、替换执行）。
  - `extractMime.js`、`globMatchToDNRRegex.js` 可用于规则匹配与类型识别。
- 存储与配置：
  - 使用 `src/storage.ts`（可替代 `keyvalDB.js` / `mainStorage.js`）管理 IndexedDB 和 `chrome.storage.local`。
  - `headerRule.js`、`webRule.js` 等文件可参考规则对象结构。
- UI 与配置交互：
  - `src/options.ts`、`onOffSwitch.js`、`moveableRules.js`（或对应的前端实现文件）：用于配置界面展示与管理规则、镜像与开关，页面为 `options.html`。
- 测试文件：
  - `test/globMatchToDNRRegexTest.js` 可参考测试结构新增替换流程相关的单元/集成测试。

## 九、边界情况与注意事项

- 若候选集合全部失败，必须回退到原资源并记录事件，同时可降低该资源所在 host 的优先替换策略。
- 浏览器安全策略可能阻止部分跨域替换或 CSP 约束，替换前应检查目标页面 CSP（若可获知）并在日志中记录 CSP 拦截信息。
- 若资源 URL 含有动态签名或时间戳参数，替换时推荐移除或标准化查询参数以提高候选命中率；同时注意避免破坏合法签名。
- 网络抖动导致断续失败时，短期标记策略（指数退避或固定黑名单周期）能减少重复失败写入与用户影响。

## 十、测试建议（验证替换流程）

1. 功能性测试：使用测试页面提供两个或更多来源的同一资源（带相同 `integrity`），模拟不同延迟并验证扩展按统计优先替换为更快的来源。
2. 故障测试：让候选来源返回错误或SRI失败，检查扩展是否回退并标记候选为不可用。
3. 并发与 host 限制测试：在含大量资源的页面上触发替换，验证同host并发限制与不同host上限生效。
4. TTL 与清理测试：验证统计与 integrity 映射表在 TTL 到期后被清理。

## 十一、后续改进建议（非必须）

- 增加 A/B 测试能力以评估替换策略对实际页面性能的影响。
- 支持基于地理位置或网络条件的候选优先级调整（例如通过 ping/主动测速补充统计）。
- 在 UI 中展示候选来源的历史可用性与性能分布，帮助用户决策。

---

撰写人：
日期：2025-10-18
