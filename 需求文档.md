# 需求文档：浏览器扩展 - MirrorBoost

## 文档信息
- **文档版本**：v0.6
- **文档版本**：v0.7
- **创建日期**：2025-10-17
- **产品经理**：xxx
- **最后更新**：2025-10-18

## 1. 引言
### 1.1 背景
许多网站在加载静态资源（如样式表、JavaScript脚本和图标）时，未使用CDN或缓存优化技术，导致用户访问时加载缓慢，影响用户体验。部分资源来源于开源库，可通过替换为镜像服务器地址来加速加载，但需确保资源完整性。

### 1.2 目标
开发一款浏览器扩展，自动监控和优化网页静态资源的加载性能。扩展通过统计资源加载时间，识别慢速资源，并安全地替换为镜像版本（仅当哈希值匹配时），以提升加载速度。扩展提供内置常用库镜像地址，并支持用户自定义配置。

### 1.3 范围
- **平台**：支持Chrome和Edge浏览器。
- **功能范围**：资源加载时间统计、阈值检查、镜像替换、用户配置管理。
- **非范围**：不修改无integrity属性的资源；不涉及服务器端优化。

## 2. 用户故事
| ID  | 用户角色 | 需求描述 | 优先级 |
|-----|----------|----------|---------|
| US01 | 终端用户 | 我希望扩展自动统计网页中所有静态资源（样式、脚本、图标）的平均加载时间，以便识别性能瓶颈。 | 高 |
| US02 | 终端用户 | 我希望扩展对加载时间超过阈值的资源，自动替换为镜像服务器地址，但仅当资源带有integrity属性且哈希值匹配时，以确保安全性和加速加载。 | 高 |
| US03 | 高级用户 | 我希望扩展内置常用开源库的镜像地址（如CDNJS、unpkg等），并允许我自定义其他镜像服务器地址和URL匹配规则，以适应个性化需求。 | 中 |
| US04 | 用户 | 我希望扩展提供一个简单的配置界面，让我轻松启用/禁用功能、调整阈值和管理镜像规则，而无需技术知识。 | 中 |
| US05 | 终端用户 | 我希望扩展按URL匹配规则或按host统计资源的平均加载时间并记录到数据库，以便基于统计数据进行更精准的替换。 | 高 |
| US06 | 终端用户 | 我希望扩展能根据每条匹配规则或每个host的平均加载时间，用更短加载时间的资源替换加载时间更长的资源，从而进一步提升页面加载性能。 | 高 |
| US06-1 | 终端用户 | 我希望当存在多个可替换来源时，扩展优先从平均加载时间更低的来源集合中随机选取目标，以避免总是选取同一来源造成负载集中；同时对同一host的并发替换数和一次替换过程中涉及的不同host数量应有限制以降低DNS和并发压力。 | 高 |
| US07 | 终端用户 | 我希望能配置统计信息的有效期（TTL），默认30天，过期的统计数据自动删除，以节省存储并保持数据新鲜。 | 中 |
| US08 | 高级用户 | 我希望扩展在检测到某个host的资源平均加载时间超过阈值且没有对应URL匹配规则时，能自动添加按host的URL匹配规则（该功能可开启/关闭）。 | 中 |
| US09 | 终端用户 | 当鼠标悬浮在扩展图标时，我希望看到当前页面每个类型的资源（如CSS、JS、图标）的平均加载时间，以便快速了解页面资源性能。 | 高 |
| US10 | 用户 | 我希望能配置最小统计样本数，只有当某资源/规则/host的加载次数达到该数值时，扩展才进行平均加载时间的计算和替换操作，默认3次。 | 高 |

## 3. 功能需求
### 3.1 资源监控与统计
- **需求描述**：扩展需自动监控网页中所有静态资源（包括CSS样式表、JavaScript脚本和图标）的加载时间。
- **详细说明**：
  - 在网页加载时，扩展通过浏览器API（如Resource Timing API）收集每个资源的加载时间。
  - 统计资源的平均加载时间。
  - 统计层级：
    - 如果资源URL匹配已定义的URL匹配规则（规则优先级高于host统计），则按该匹配规则进行统计（所有匹配到该规则的URL共用一组统计数据）。
    - 如果资源URL不在任何匹配规则内，则根据资源的host（域名）进行统计（在启用按host统计时生效）。
  - 数据存储：将统计数据（包含样本计数、平均加载时间、最后更新时间、创建时间和规则/host标识）写入扩展的本地数据库。
  - 样本数要求：在进行平均值计算或基于统计进行替换操作前，扩展应检查该统计条目的样本计数是否达到配置的最小统计样本数（见配置项）。默认最小样本数为3次；只有当样本计数达到或超过该值时，才对该条目计算稳定的平均值并允许替换行为。

### 3.1.2 资源选择策略（并发与host限制）
- **需求描述**：当存在多个可用镜像/来源可用于替换某资源时，扩展应优先从平均加载时间更低的来源集合中随机选取目标；同时为避免过度集中在单一host或产生额外DNS压力，需限制对同一host的并发替换数以及一次替换过程中涉及的不同host数量。
- **详细说明**：
  - 选择策略：对同一替换规则或同一资源候选集合，按统计的平均加载时间排序并选取一组（例如最短的前N个候选，N可配置，默认3）；从该集合中随机选择一个用于替换，避免始终固定使用同一来源。
  - 并发限制：限制同一host在同一页面或同一替换会话中的并发替换数（默认值可配置，建议默认2个并发）。
  - 不同host数量限制：限制一次替换操作触发的不同host数量上限（默认可配置，建议为4），以降低DNS并发解析压力与连接数开销。
  - 回退与监测：若替换后检测到加载失败或完整性校验失败，应记录并临时将该候选标记为不可用，继续从剩余候选中选取或回退到原资源。
  - 配置项：在配置界面提供相关设置（候选集合大小N、同host并发上限、不同host上限），并在界面中解释默认值与风险权衡。

### 3.1.1 统计有效期（TTL）
- **需求描述**：支持为统计信息配置有效期，默认30天，过期的统计条目自动删除。
- **详细说明**：
  - 默认TTL为30天（可在配置界面修改）。
  - 在扩展启动或周期性任务中删除超过TTL的统计记录。

### 3.2 阈值检查与过滤
- **需求描述**：扩展需根据预设阈值过滤慢速资源，仅处理加载时间超过阈值的资源。
- **详细说明**：
  - 阈值可配置：默认设置为300ms（用户可调整）。
  - 仅在资源带有`integrity`属性时才考虑替换（该属性用于Subresource Integrity 校验）。扩展本身不计算或比较哈希值；哈希/完整性校验由浏览器执行。
  - 扩展在替换后会监测替换资源的加载结果（例如通过资源加载成功/失败事件或资源时序），若出现因完整性不匹配或网络错误导致的加载失败，扩展应记录日志并按配置回退或保留原资源。
  - 如果资源无`integrity`属性，即使超过阈值，也不进行替换。
  - 平均值计算与替换还需满足最小统计样本数条件（见配置项，默认3次）。

### 3.2.1 按资源类型限制规则生效
- **需求描述**：URL匹配规则应支持限定仅对特定资源类型生效（例如仅对CSS、仅对JS、仅对图标或任意组合），以便用户能够更精细地控制替换策略。
- **详细说明**：
  - 规则语法扩展：每条URL匹配规则支持一个可选的 `resourceTypes` 字段，表示该规则仅在资源类型匹配时生效。示例类型：`css`、`js`、`image`（图标/图片）、`font` 等。若该字段为空或未设置，则规则对所有资源类型生效。
  - 资源类型识别：扩展应基于资源元素的类型（如link rel=stylesheet、script 标签或 Resource Timing/initiatorType）判断资源类型，并据此决定规则是否适用。
  - UI 支持：在规则管理界面提供复选项以选择生效的资源类型，默认选择“所有类型”。
  - 配置导入/导出：在导入规则时若包含 `resourceTypes` 字段，应校验类型集合有效性并提示不兼容项。

### 3.3 镜像替换与哈希验证
- **需求描述**：对过滤出的慢速资源，扩展需安全地替换为镜像服务器地址，并确保哈希值匹配。
- **详细说明**：
  - 替换前后关于完整性校验的职责划分：扩展不在客户端重复计算或直接比对资源哈希。对带有`integrity`属性的资源，浏览器会在加载时执行 SRI 校验；扩展应依赖浏览器的校验结果。
  - 扩展的行为流程（高层描述）：
    1. 识别满足替换条件的资源（包括带有 `integrity` 属性且统计/阈值条件满足）。
    2. 将资源 URL 替换为镜像地址（由浏览器负责实际加载与完整性校验）。
    3. 监测替换后的资源是否成功加载（未触发完整性或网络错误）。若检测到加载失败或浏览器未能通过完整性校验，扩展记录错误并按配置回退到原资源或采取其它容错策略。
  - 这一流程既避免了重复计算哈希的开销，也依赖浏览器对完整性验证的权威性，同时通过加载结果检测保证不会把不可用或完整性不匹配的资源长期生效。
  - 替换过程需异步进行，避免阻塞网页加载。
  - 基于统计的智能替换：扩展将比较同一匹配规则或同一host下不同源的平均加载时间，使用加载时间更短的资源替换加载时间长的资源（前提仍是哈希验证通过并满足阈值策略）。
  - 在替换候选来源集合中应用“资源选择策略”（见 3.1.2），从统计上较短的候选集合中随机选取，同时遵守同host并发与不同host数量限制以降低DNS与并发开销。

### 3.4 内置镜像库
- **需求描述**：扩展内置常用开源库的镜像服务器地址（如jQuery、Bootstrap、Font Awesome等）。
- **详细说明**：
  - 内置镜像列表以配置文件形式存储，包括镜像URL模板和资源匹配规则。
  - 示例：原资源URL为`https://example.com/lib/jquery.js`，可替换为`https://cdnjs.cloudflare.com/ajax/libs/jquery/x.x.x/jquery.js`。

### 3.5 用户配置管理
- **需求描述**：允许用户自定义镜像服务器地址、URL匹配规则和全局设置。
- **详细说明**：
  - **配置项**：
    - 镜像服务器地址：用户可添加、编辑或删除镜像URL。
    - URL匹配规则：支持正则表达式或通配符，用于识别可替换的资源。
    - 加载时间阈值：用户可设置自定义阈值（单位：ms）。
    - 启用/禁用URL匹配：全局开关，默认启用，但是规则为空。
  - 规则生效的资源类型：规则可配置仅对指定资源类型生效（例如：CSS、JS、图标等）。
  - 启用/禁用按host统计：默认启用（若禁用，则对未匹配到规则的URL不会按host统计）。
  - 统计信息TTL：以天为单位，默认30天。
  - 启用/禁用自动添加host匹配规则：默认启用。
- **配置界面**：提供一个浏览器扩展选项页面，使用表单和列表管理配置。界面需直观，支持导入/导出配置。
- **配置生效范围**：修改配置后仅对新打开或刷新后的页面生效。已打开的页面在配置修改后不会自动应用新设置，需手动刷新该页面才能应用新配置。配置保存后，配置页面应显示明确提示（例如："配置已保存；仅在新打开或刷新后的页面生效"）。

#### 3.5.1 配置数据的存储方式

- 存储位置与格式：
  - 扩展运行期的轻量配置（包括镜像服务器列表、全局设置、UI偏好等）应使用浏览器提供的本地存储接口持久化（优先使用 `chrome.storage.local`），以键值对的 JSON 形式保存，便于导入/导出与同步处理。
  - 结构化且规模较大的统计数据（样本计数、平均加载时间、时间戳等）应使用 IndexedDB 或现有的本地数据库封装（例如项目中的 `keyvalDB`），以支持高效查询、TTL 清理与批量操作。
  - 日志数据（当日志开关开启时）可以存放于同一 IndexedDB 的独立表中，但必须使用采样和限流策略，避免占用过多本地存储。
- 建议的数据结构：
  - 配置顶层（存于 storage.local）示例：
    - { "version":"0.6", "settings":{...}, "mirrors":[...], "rules":[...], "ui":{...} }
  - 单条规则条目（rules）示例，必须包含来源字段：
    - {
      "id": "string",
      "pattern": "string",
      "type": "url" | "host",
      "resourceTypes": ["css" | "js" | "image" | "font"],
      "enabled": true | false,
      "source": "user" | "auto",
      "originInfo": {
         "reason": "string",
         "host": "string (可选)",
         "sampleCount": number,
         "detectedAt": "ISO timestamp"
      },
      "createdAt": "ISO timestamp",
      "updatedAt": "ISO timestamp"
    }
  - 统计记录示例（IndexedDB 表）：
    - { "key": "rule:<id>" | "host:<host>", "samples": number, "avgMs": number, "firstAt": "ISO", "lastAt": "ISO" }

- 迁移与备份：
  - 启动时读取配置中的 `version` 字段并执行必要的迁移；迁移操作前应创建本地备份（例如 `backup.<timestamp>`），并在迁移异常时回退。
  - 提供 JSON 导入/导出功能，导入前校验 schema 并提示覆盖或合并策略。
- 存储限制与容错：
  - 考虑浏览器对 storage.local 与 IndexedDB 的配额限制：在写入失败时应使用内存缓存并在界面提示用户；对日志和历史统计数据应实现轮换或裁剪操作以防止超限。
- 隐私与安全：
  - 默认不将任何数据上传至远程服务器；仅在用户显式导出或在未来实现的同步功能中才进行上传，并需获得用户授权。
  - 对潜在敏感字段在界面中明确告知其用途与存储位置。

### 3.6 错误处理与日志
- **需求描述**：扩展需处理常见错误（如网络失败、哈希不匹配），并提供日志功能。
- **详细说明**：
  - 记录替换成功/失败事件，用户可在扩展界面查看简要日志。
  - 错误时不影响网页正常功能，仅跳过替换。
  - 日志默认关闭：默认情况下，日志功能处于“关闭”状态，避免对性能造成影响。仅在用户在配置界面显式开启日志时才会开始记录。
  - 性能与采样限制：当启用日志时，日志收集应采用采样、限流或摘要方式（例如仅记录错误/失败事件、每类事件上限或按时间窗口采样）以最小化对页面加载性能和存储的影响。
  - 配置页面提示：在配置界面对日志开关应给出清晰说明，例如："日志默认关闭；仅在调试或问题排查时开启。开启日志可能对性能产生轻微影响且会消耗本地存储。"

### 3.7 自动添加匹配规则
- **需求描述**：当检测到某个host下资源的平均加载时间超过配置阈值，且当前没有匹配到任何URL规则时，扩展可自动生成一条按host匹配的URL规则并加入规则列表（该行为可由用户配置开关控制，默认开启）。
- **详细说明**：
- 触发条件：
  1. host的平均加载时间超过阈值
  2. 样本数达到配置的最小统计样本数（默认3次，最小样本数可配置）。
- 新规则内容：基于host生成一个通配或正则规则（例如："*://example.com/*"），默认状态为禁用或启用由配置决定（建议认启用且用户可在UI中编辑/删除）。
- 日志与提示：自动添加规则时记录操作日志，并在扩展界面提供通知/提示，允许用户回滚或编辑规则。
- 来源标记与区分：
  - 每条由扩展自动生成的规则必须在规则对象中包含 `source: "auto"` 的标识（与用户在界面或导入中手动添加的规则 `source: "user"` 区分）。
  - 自动生成规则的 `originInfo` 字段应包含触发原因（例如："host_avg_exceeds_threshold"）、触发时的样本数与检测时间戳，便于审计与回溯。
- 界面清理/管理功能：
  - 在规则管理界面应提供筛选与分组视图，至少支持按 `source`（user/auto）过滤；默认将用户规则与自动规则分组显示。
  - 增加一键“清除自动生成规则”功能：
    - 操作需在 UI 中明确标注影响范围（例如：将删除全部自动规则或仅删除符合筛选条件的自动规则）。
    - 操作执行前需要用户二次确认（模态确认框），并在完成后在界面显示可撤销提示（例如："已删除 N 条自动规则，点击撤销"），撤销操作应在短时间窗口内（如 30 秒内）可用。
    - 清除操作应记录日志（采样）并可通过导出功能导出操作历史。
- 可配置行为：
  - 自动生成规则的默认启用状态由配置项决定；用户可以选择自动生成规则默认禁用以便手动审阅后启用。
  - 提供策略选项：自动生成规则是否自动应用到页面（立即生效/仅加入规则列表等待用户启用）。

## 4. 非功能需求
### 4.1 性能
- 扩展自身资源占用应最小化，对网页加载性能影响低于5%。
- 资源替换过程需异步执行，避免增加额外延迟。
- 测量基准与方法：为确保"影响低于5%"的可重复验证性，采用以下测量基准与方法：
  1. 指标定义：主要使用页面完全加载时间（document load time）作为基准测量指标；在可用时同时报告关键渲染指标（如LCP）作为补充。最终验收以页面完全加载时间的中位数（median）为主。
  2. 对比公式：性能影响用百分比表示，按公式计算：
     ((T_with_extension - T_without_extension) / T_without_extension) * 100%
     其中 T_with_extension 是在相同环境和条件下启用扩展的页面中位数加载时间，T_without_extension 是未启用扩展时的页面中位数加载时间。
  3. 测试环境与样本：建议在受控环境下进行测试（固定浏览器版本、固定机器/CPU、固定网络条件，如有必要使用网络限制工具），对每个页面至少运行30次测量（可分为冷缓存和热缓存两组，各不少于15次），以取得稳定的中位数结果。
  4. 工具与可重复性：推荐使用自动化工具（如 WebPageTest、Lighthouse 的批量脚本或 Puppeteer/Playwright 自动化脚本）来执行重复测量，确保测试可重现并能导出统计结果。
  5. 验收规则：当在代表性测试集合（包含常见站点或内部样例页）的中位数页面完全加载时间按上述方法计算后，扩展导致的性能影响百分比在95%置信区间内小于5%时，视为通过性能要求。

### 4.2 安全性
- 严格依赖`integrity`属性进行哈希验证，防止恶意资源注入。
- 用户配置数据本地存储，不上传到远程服务器，确保隐私。

### 4.3 可用性
- 扩展安装后即用，默认配置覆盖常见场景。
- 配置界面简洁，支持一键重置。

### 4.4 兼容性
- 支持浏览器版本：支持Chrome和Edge浏览器。
- 遵循Web标准，确保与主流网站兼容。

## 5. 假设与依赖
- **假设**：
  - 用户了解镜像服务器基本概念，并拥有可用的镜像地址。
  - 目标网页的静态资源包含`integrity`属性。
- **依赖**：
  - 浏览器扩展API（如Chrome Extensions API或WebExtensions API）。
  - 镜像服务器的可用性和稳定性（第三方服务，如CDNJS）。

## 6. 验收标准
- **AC01**：给定一个包含慢速资源的网页，扩展能正确计算所有样式、脚本和图标的平均加载时间，误差低于10%。
- **AC02**：当资源加载时间超过阈值且带有`integrity`属性时，扩展会尝试替换为镜像地址；浏览器在加载时负责执行 SRI 校验。扩展应监测替换后资源的加载结果，确保替换不会引入完整性或功能问题。
- **AC03**：如果替换后资源因完整性校验失败或加载错误而不可用，扩展应记录错误日志并按配置回退到原资源并停止替换该资源。
- **AC04**：用户可通过配置界面添加新镜像服务器和规则，添加后扩展能应用新规则。
- **AC05**：启用扩展时，对网页性能影响可接受（通过工具测试量化，依据文档中定义的测量基准与方法，性能影响低于5%）。
- **AC06**：统计分层与持久化：当URL匹配规则存在时，统计按规则聚合；当不存在时且按host统计启用时，统计按host聚合，统计数据能正确写入本地数据库并随TTL过期清理。
- **AC07**：基于统计的替换：扩展能比较同一规则/host下的资源平均加载时间，并用加载时间更短的资源替换加载时间更长的资源。替换后由浏览器在加载时执行完整性校验；扩展依赖校验结果并在发现完整性或加载问题时记录日志并回退或禁用该替换规则。替换操作可配置启用/禁用。
- **AC08**：自动规则添加：在启用该功能时，当某host的平均加载时间超过阈值且没有对应URL规则时，扩展能自动添加一条按host匹配的URL规则，并在界面中提供日志与可编辑选项。
- **AC08-1**：自动规则来源标识：所有自动添加的规则在规则对象中应包含 `source: "auto"` 字段，用以区分用户手动添加的规则；`originInfo` 字段应包含触发原因、样本数和时间戳等元信息。
- **AC08-2**：界面清除自动规则：在规则管理界面中提供“清除自动生成规则”功能（支持筛选后清除），该操作需二次确认并提供短时间窗口的撤销机制，清除操作结果应记录并可导出。
- **AC09**：配置项：用户能在配置界面设置统计TTL、启用/禁用自动添加规则以及启用/禁用按host统计，默认TTL=30天，自动添加规则和按host统计默认启用。
- **AC10**：当鼠标悬浮在浏览器扩展图标上时，扩展显示当前页面每个资源类型（至少包括CSS、JS、图标）的平均加载时间（仅显示样本计数达到或超过最小统计样本数的条目）。
- **AC11**：最小统计样本数：扩展在配置界面提供“最小统计样本数”设置，默认值为3；在统计条目样本计数低于该设置时，不参与平均值展示、替换或自动添加规则的触发判断。
- **AC12**：日志默认关闭：扩展的日志功能在默认配置下为“关闭”，仅在用户显式开启后才收集日志；配置界面需显示提示说明仅建议在调试时开启，并且日志收集需采用采样/限流以降低开销。
- **AC13**：配置生效范围：配置修改后仅在新打开或刷新后的页面生效；配置保存后界面需显示提示，告知用户已保存并需刷新已打开页面以应用新配置。
