# 需求文档：浏览器扩展 - MirrorBoost

## 文档信息
- **文档版本**：v0.5
- **创建日期**：2025-10-17
- **产品经理**：xxx
- **最后更新**：2025-10-18

## 1. 引言
### 1.1 背景
许多网站在加载静态资源（如样式表、JavaScript脚本和图标）时，未使用CDN或缓存优化技术，导致用户访问时加载缓慢，影响用户体验。部分资源来源于开源库，可通过替换为镜像服务器地址来加速加载，但需确保资源完整性。

### 1.2 目标
开发一款浏览器扩展，自动监控和优化网页静态资源的加载性能。扩展通过统计资源加载时间，识别慢速资源，并安全地替换为镜像版本（仅当哈希值匹配时），以提升加载速度。扩展提供内置常用库镜像地址，并支持用户自定义配置。

### 1.3 范围
- **平台**：支持Chrome和Edge浏览器。
- **功能范围**：资源加载时间统计、阈值检查、镜像替换、用户配置管理。
- **非范围**：不修改无integrity属性的资源；不涉及服务器端优化。

## 2. 用户故事
| ID  | 用户角色 | 需求描述 | 优先级 |
|-----|----------|----------|---------|
| US01 | 终端用户 | 我希望扩展自动统计网页中所有静态资源（样式、脚本、图标）的平均加载时间，以便识别性能瓶颈。 | 高 |
| US02 | 终端用户 | 我希望扩展对加载时间超过阈值的资源，自动替换为镜像服务器地址，但仅当资源带有integrity属性且哈希值匹配时，以确保安全性和加速加载。 | 高 |
| US03 | 高级用户 | 我希望扩展内置常用开源库的镜像地址（如CDNJS、unpkg等），并允许我自定义其他镜像服务器地址和URL匹配规则，以适应个性化需求。 | 中 |
| US04 | 用户 | 我希望扩展提供一个简单的配置界面，让我轻松启用/禁用功能、调整阈值和管理镜像规则，而无需技术知识。 | 中 |
| US05 | 终端用户 | 我希望扩展按URL匹配规则或按host统计资源的平均加载时间并记录到数据库，以便基于统计数据进行更精准的替换。 | 高 |
| US06 | 终端用户 | 我希望扩展能根据每条匹配规则或每个host的平均加载时间，用更短加载时间的资源替换加载时间更长的资源，从而进一步提升页面加载性能。 | 高 |
| US07 | 终端用户 | 我希望能配置统计信息的有效期（TTL），默认30天，过期的统计数据自动删除，以节省存储并保持数据新鲜。 | 中 |
| US08 | 高级用户 | 我希望扩展在检测到某个host的资源平均加载时间超过阈值且没有对应URL匹配规则时，能自动添加按host的URL匹配规则（该功能可开启/关闭）。 | 中 |
| US09 | 终端用户 | 当鼠标悬浮在扩展图标时，我希望看到当前页面每个类型的资源（如CSS、JS、图标）的平均加载时间，以便快速了解页面资源性能。 | 高 |
| US10 | 用户 | 我希望能配置最小统计样本数，只有当某资源/规则/host的加载次数达到该数值时，扩展才进行平均加载时间的计算和替换操作，默认3次。 | 高 |

## 3. 功能需求
### 3.1 资源监控与统计
- **需求描述**：扩展需自动监控网页中所有静态资源（包括CSS样式表、JavaScript脚本和图标）的加载时间。
- **详细说明**：
  - 在网页加载时，扩展通过浏览器API（如Resource Timing API）收集每个资源的加载时间。
  - 统计资源的平均加载时间。
  - 统计层级：
    - 如果资源URL匹配已定义的URL匹配规则（规则优先级高于host统计），则按该匹配规则进行统计（所有匹配到该规则的URL共用一组统计数据）。
    - 如果资源URL不在任何匹配规则内，则根据资源的host（域名）进行统计（在启用按host统计时生效）。
  - 数据存储：将统计数据（包含样本计数、平均加载时间、最后更新时间、创建时间和规则/host标识）写入扩展的本地数据库。
  - 样本数要求：在进行平均值计算或基于统计进行替换操作前，扩展应检查该统计条目的样本计数是否达到配置的最小统计样本数（见配置项）。默认最小样本数为3次；只有当样本计数达到或超过该值时，才对该条目计算稳定的平均值并允许替换行为。

### 3.1.1 统计有效期（TTL）
- **需求描述**：支持为统计信息配置有效期，默认30天，过期的统计条目自动删除。
- **详细说明**：
  - 默认TTL为30天（可在配置界面修改）。
  - 后端维护定期清理任务，在扩展启动或周期性任务中删除超过TTL的统计记录。

### 3.2 阈值检查与过滤
- **需求描述**：扩展需根据预设阈值过滤慢速资源，仅处理加载时间超过阈值的资源。
- **详细说明**：
  - 阈值可配置：默认设置为300ms（用户可调整）。
  - 仅在资源带有`integrity`属性时才考虑替换（该属性用于Subresource Integrity 校验）。扩展本身不计算或比较哈希值；哈希/完整性校验由浏览器执行。
  - 扩展在替换后会监测替换资源的加载结果（例如通过资源加载成功/失败事件或资源时序），若出现因完整性不匹配或网络错误导致的加载失败，扩展应记录日志并按配置回退或保留原资源。
  - 如果资源无`integrity`属性，即使超过阈值，也不进行替换。
  - 平均值计算与替换还需满足最小统计样本数条件（见配置项，默认3次）。

### 3.3 镜像替换与哈希验证
- **需求描述**：对过滤出的慢速资源，扩展需安全地替换为镜像服务器地址，并确保哈希值匹配。
- **详细说明**：
  - 替换前后关于完整性校验的职责划分：扩展不在客户端重复计算或直接比对资源哈希。对带有`integrity`属性的资源，浏览器会在加载时执行 SRI 校验；扩展应依赖浏览器的校验结果。
  - 扩展的行为流程（高层描述）：
    1. 识别满足替换条件的资源（包括带有 `integrity` 属性且统计/阈值条件满足）。
    2. 将资源 URL 替换为镜像地址（由浏览器负责实际加载与完整性校验）。
    3. 监测替换后的资源是否成功加载（未触发完整性或网络错误）。若检测到加载失败或浏览器未能通过完整性校验，扩展记录错误并按配置回退到原资源或采取其它容错策略。
  - 这一流程既避免了重复计算哈希的开销，也依赖浏览器对完整性验证的权威性，同时通过加载结果检测保证不会把不可用或完整性不匹配的资源长期生效。
  - 替换过程需异步进行，避免阻塞网页加载。
  - 基于统计的智能替换：扩展将比较同一匹配规则或同一host下不同源的平均加载时间，使用加载时间更短的资源替换加载时间长的资源（前提仍是哈希验证通过并满足阈值策略）。

### 3.4 内置镜像库
- **需求描述**：扩展内置常用开源库的镜像服务器地址（如jQuery、Bootstrap、Font Awesome等）。
- **详细说明**：
  - 内置镜像列表以配置文件形式存储，包括镜像URL模板和资源匹配规则。
  - 示例：原资源URL为`https://example.com/lib/jquery.js`，可替换为`https://cdnjs.cloudflare.com/ajax/libs/jquery/x.x.x/jquery.js`。

### 3.5 用户配置管理
- **需求描述**：允许用户自定义镜像服务器地址、URL匹配规则和全局设置。
- **详细说明**：
  - **配置项**：
    - 镜像服务器地址：用户可添加、编辑或删除镜像URL。
    - URL匹配规则：支持正则表达式或通配符，用于识别可替换的资源。
    - 加载时间阈值：用户可设置自定义阈值（单位：ms）。
    - 启用/禁用URL匹配：全局开关。
  - 启用/禁用按host统计：默认启用（若禁用，则对未匹配到规则的URL不会按host统计）。
  - 统计信息TTL：以天为单位，默认30天。
  - 启用/禁用自动添加host匹配规则：默认启用。
- **配置界面**：提供一个浏览器扩展选项页面，使用表单和列表管理配置。界面需直观，支持导入/导出配置。
- **配置生效范围**：修改配置后仅对新打开或刷新后的页面生效。已打开的页面在配置修改后不会自动应用新设置，需手动刷新该页面才能应用新配置。配置保存后，配置页面应显示明确提示（例如："配置已保存；仅在新打开或刷新后的页面生效"）。

### 3.6 错误处理与日志
- **需求描述**：扩展需处理常见错误（如网络失败、哈希不匹配），并提供日志功能。
- **详细说明**：
  - 记录替换成功/失败事件，用户可在扩展界面查看简要日志。
  - 错误时不影响网页正常功能，仅跳过替换。
  - 日志默认关闭：默认情况下，日志功能处于“关闭”状态，避免对性能造成影响。仅在用户在配置界面显式开启日志时才会开始记录。
  - 性能与采样限制：当启用日志时，日志收集应采用采样、限流或摘要方式（例如仅记录错误/失败事件、每类事件上限或按时间窗口采样）以最小化对页面加载性能和存储的影响。
  - 配置页面提示：在配置界面对日志开关应给出清晰说明，例如："日志默认关闭；仅在调试或问题排查时开启。开启日志可能对性能产生轻微影响且会消耗本地存储。"

### 3.7 自动添加匹配规则
- **需求描述**：当检测到某个host下资源的平均加载时间超过配置阈值，且当前没有匹配到任何URL规则时，扩展可自动生成一条按host匹配的URL规则并加入规则列表（该行为可由用户配置开关控制，默认开启）。
- **详细说明**：
- 触发条件：
  1. host的平均加载时间超过阈值
  2. 样本数达到配置的最小统计样本数（默认3次，最小样本数可配置）。
- 新规则内容：基于host生成一个通配或正则规则（例如："*://example.com/*"），默认状态为禁用或启用由配置决定（建议认启用且用户可在UI中编辑/删除）。
- 日志与提示：自动添加规则时记录操作日志，并在扩展界面提供通知/提示，允许用户回滚或编辑规则。

## 4. 非功能需求
### 4.1 性能
- 扩展自身资源占用应最小化，对网页加载性能影响低于5%。
- 资源替换过程需异步执行，避免增加额外延迟。
- 测量基准与方法：为确保"影响低于5%"的可重复验证性，采用以下测量基准与方法：
  1. 指标定义：主要使用页面完全加载时间（document load time）作为基准测量指标；在可用时同时报告关键渲染指标（如LCP）作为补充。最终验收以页面完全加载时间的中位数（median）为主。
  2. 对比公式：性能影响用百分比表示，按公式计算：
     ((T_with_extension - T_without_extension) / T_without_extension) * 100%
     其中 T_with_extension 是在相同环境和条件下启用扩展的页面中位数加载时间，T_without_extension 是未启用扩展时的页面中位数加载时间。
  3. 测试环境与样本：建议在受控环境下进行测试（固定浏览器版本、固定机器/CPU、固定网络条件，如有必要使用网络限制工具），对每个页面至少运行30次测量（可分为冷缓存和热缓存两组，各不少于15次），以取得稳定的中位数结果。
  4. 工具与可重复性：推荐使用自动化工具（如 WebPageTest、Lighthouse 的批量脚本或 Puppeteer/Playwright 自动化脚本）来执行重复测量，确保测试可重现并能导出统计结果。
  5. 验收规则：当在代表性测试集合（包含常见站点或内部样例页）的中位数页面完全加载时间按上述方法计算后，扩展导致的性能影响百分比在95%置信区间内小于5%时，视为通过性能要求。

### 4.2 安全性
- 严格依赖`integrity`属性进行哈希验证，防止恶意资源注入。
- 用户配置数据本地存储，不上传到远程服务器，确保隐私。

### 4.3 可用性
- 扩展安装后即用，默认配置覆盖常见场景。
- 配置界面简洁，支持一键重置。

### 4.4 兼容性
- 支持浏览器版本：支持Chrome和Edge浏览器。
- 遵循Web标准，确保与主流网站兼容。

## 5. 假设与依赖
- **假设**：
  - 用户了解镜像服务器基本概念，并拥有可用的镜像地址。
  - 目标网页的静态资源包含`integrity`属性。
- **依赖**：
  - 浏览器扩展API（如Chrome Extensions API或WebExtensions API）。
  - 镜像服务器的可用性和稳定性（第三方服务，如CDNJS）。

## 6. 验收标准
- **AC01**：给定一个包含慢速资源的网页，扩展能正确计算所有样式、脚本和图标的平均加载时间，误差低于10%。
- **AC02**：当资源加载时间超过阈值且带有`integrity`属性时，扩展会尝试替换为镜像地址；浏览器在加载时负责执行 SRI 校验。扩展应监测替换后资源的加载结果，确保替换不会引入完整性或功能问题。
- **AC03**：如果替换后资源因完整性校验失败或加载错误而不可用，扩展应记录错误日志并按配置回退到原资源或停止替换该资源。
- **AC04**：用户可通过配置界面添加新镜像服务器和规则，添加后扩展能应用新规则。
- **AC05**：启用扩展时，对网页性能影响可接受（通过工具测试量化，依据文档中定义的测量基准与方法，性能影响低于5%）。
- **AC06**：统计分层与持久化：当URL匹配规则存在时，统计按规则聚合；当不存在时且按host统计启用时，统计按host聚合，统计数据能正确写入本地数据库并随TTL过期清理。
- **AC07**：基于统计的替换：扩展能比较同一规则/host下的资源平均加载时间，并用加载时间更短的资源替换加载时间更长的资源。替换后由浏览器在加载时执行完整性校验；扩展依赖校验结果并在发现完整性或加载问题时记录日志并回退或禁用该替换规则。替换操作可配置启用/禁用。
- **AC08**：自动规则添加：在启用该功能时，当某host的平均加载时间超过阈值且没有对应URL规则时，扩展能自动添加一条按host匹配的URL规则，并在界面中提供日志与可编辑选项。
- **AC09**：配置项：用户能在配置界面设置统计TTL、启用/禁用自动添加规则以及启用/禁用按host统计，默认TTL=30天，自动添加规则和按host统计默认启用。
- **AC10**：当鼠标悬浮在浏览器扩展图标上时，扩展显示当前页面每个资源类型（至少包括CSS、JS、图标）的平均加载时间（仅显示样本计数达到或超过最小统计样本数的条目）。
- **AC11**：最小统计样本数：扩展在配置界面提供“最小统计样本数”设置，默认值为3；在统计条目样本计数低于该设置时，不参与平均值展示、替换或自动添加规则的触发判断。
- **AC12**：日志默认关闭：扩展的日志功能在默认配置下为“关闭”，仅在用户显式开启后才收集日志；配置界面需显示提示说明仅建议在调试时开启，并且日志收集需采用采样/限流以降低开销。
- **AC13**：配置生效范围：配置修改后仅在新打开或刷新后的页面生效；配置保存后界面需显示提示，告知用户已保存并需刷新已打开页面以应用新配置。
